<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Spotify Jam</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
    />
  </head>
  <body>
    <!-- <div>
      <button onclick="document.getElementById('player').play()">Play</button>
      <button onclick="document.getElementById('player').pause()">Pause</button>
      <button onclick="document.getElementById('player').volume += 0.1">
        Vol +
      </button>
      <button onclick="document.getElementById('player').volume -= 0.1">
        Vol -
      </button>
    </div> -->
    <div class="navbar bg-base-300">
      <button class="btn btn-ghost text-xl">Product Name</button>
    </div>
    <div class="flex">
      <div class="w-2/3 h-96">
        <div class="p-2">
          <label class="input input-bordered flex items-center gap-2">
            <input id="songurl" type="text" class="grow" placeholder="Search" />
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
          </label>
        </div>

        <div class="overflow-x-auto">
          <table class="table">
            <!-- head -->
            <thead>
              <tr>
                <th>Queue Number</th>
                <th>Song Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="queuelist">
              <!-- row 1 -->
              <tr id="queue-0000">
                <td class="w-1/12">#1</td>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="avatar">
                      <div class="mask mask-squircle w-12 h-12">
                        <img
                          src="https://img.daisyui.com/tailwind-css-component-profile-2@56w.png"
                          alt="Avatar Tailwind CSS Component"
                        />
                      </div>
                    </div>
                    <div>
                      <div class="font-bold">Song Name</div>
                      <div class="text-sm opacity-50">Artist Name</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="flex">
                    <button class="btn btn-error btn-sm">
                      Remove
                      <span class="material-symbols-outlined">close</span>
                    </button>
                  </div>
                </td>
              </tr>
              <!-- row 2 -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="w-1/3">
        <audio id="songplayer" src="/music/musicfile.mp3"></audio>
        <div class="px-10 pt-10 pb-4 flex items-center z-50">
          <img
            data-amplitude-song-info="cover_art_url"
            class="w-24 h-24 rounded-md mr-6 border border-bg-player-light-background dark:border-cover-dark-border"
          />

          <div class="flex flex-col">
            <span
              data-amplitude-song-info="name"
              class="font-sans text-lg font-medium leading-7 text-slate-900 dark:text-white"
            ></span>
            <span
              data-amplitude-song-info="artist"
              class="font-sans text-base font-medium leading-6 text-gray-500 dark:text-gray-400"
            ></span>
            <span
              data-amplitude-song-info="album"
              class="font-sans text-base font-medium leading-6 text-gray-500 dark:text-gray-400"
            ></span>
          </div>
        </div>
        <div class="w-full flex flex-col px-10 pb-6 z-50">
          <input
            type="range"
            id="song-percentage-played"
            class="amplitude-song-slider mb-3"
            step=".05"
          />
          <div class="flex w-full justify-between">
            <span
              class="amplitude-current-time text-xs font-sans tracking-wide font-medium text-sky-500 dark:text-sky-300"
            ></span>
            <span
              class="amplitude-duration-time text-xs font-sans tracking-wide font-medium text-gray-500"
            ></span>
          </div>
        </div>
        <div
          class="h-control-panel px-10 rounded-b-xl bg-control-panel-light-background border-t border-gray-200 flex items-center justify-between z-50 dark:bg-control-panel-dark-background dark:border-gray-900"
        >
          <div class="cursor-pointer amplitude-prev px-2">
            <svg
              width="32"
              height="32"
              viewBox="0 0 32 32"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M26 7C26 5.76393 24.5889 5.05836 23.6 5.8L11.6 14.8C10.8 15.4 10.8 16.6 11.6 17.2L23.6 26.2C24.5889 26.9416 26 26.2361 26 25V7Z"
                fill="#94A3B8"
                stroke="#94A3B8"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M6 5L6 27"
                stroke="#94A3B8"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
          <div
            class="cursor-pointer amplitude-play-pause w-24 h-24 rounded-full bg-white border border-play-pause-light-border shadow-xl flex items-center justify-center dark:bg-play-pause-dark-background dark:border-play-pause-dark-border"
            onclick="playpause()"
          >
            <svg
              id="play-icon"
              class="ml-[10px]"
              width="31"
              height="37"
              viewBox="0 0 31 37"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M29.6901 16.6608L4.00209 0.747111C2.12875 -0.476923 0.599998 0.421814 0.599998 2.75545V33.643C0.599998 35.9728 2.12747 36.8805 4.00209 35.6514L29.6901 19.7402C29.6901 19.7402 30.6043 19.0973 30.6043 18.2012C30.6043 17.3024 29.6901 16.6608 29.6901 16.6608Z"
                class="fill-slate-500 dark:fill-slate-400"
              />
            </svg>
          </div>
          <div class="cursor-pointer amplitude-next px-2">
            <svg
              width="32"
              height="32"
              viewBox="0 0 32 32"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M6 7C6 5.76393 7.41115 5.05836 8.4 5.8L20.4 14.8C21.2 15.4 21.2 16.6 20.4 17.2L8.4 26.2C7.41115 26.9416 6 26.2361 6 25V7Z"
                fill="#94A3B8"
                stroke="#94A3B8"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M26 5L26 27"
                stroke="#94A3B8"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        </div>
        <div
          class="hidden top-14 w-full absolute ml-auto mr-auto left-0 right-0 text-center max-w-lg h-72 rounded-full bg-highlight blur-2xl dark:block"
        ></div>
      </div>
    </div>

    <script>
      var socket = io.connect("http://127.0.0.1:5000", {
        transports: ["polling"], // Use long polling
        secure: true,
      });
      var audio = document.getElementById("songplayer");
      var isPlaying = false;
      var syncInterval = 5000; // Sync every 5 seconds
      var syncThreshold = 0.5; // 500 milliseconds


      socket.on("connect", function () {
        console.log("Connected to server");
        socket.emit("request_sync");
      });

      socket.on("play", function (data) {
        console.log("Play event received from server", data);
        audio.currentTime = data.timestamp;
        if (!isPlaying) {
          audio.play();
          isPlaying = true;
        }
      });

      socket.on("pause", function (data) {
        console.log("Pause event received from server", data);
        audio.currentTime = data.timestamp;
        if (isPlaying) {
          audio.pause();
          isPlaying = false;
        }
      });

      socket.on("sync", function (data) {
        console.log("Sync event received from server", data);
        var currentTimeDiff = Math.abs(audio.currentTime - data.timestamp);
        if (currentTimeDiff > syncThreshold) {
          audio.currentTime = data.timestamp;
        }
        if (data.is_playing && !isPlaying) {
          audio.play();
          isPlaying = true;
        } else if (!data.is_playing && isPlaying) {
          audio.pause();
          isPlaying = false;
        }
      });
      function playpause() {
        if (isPlaying) {
          pausesong();
        } else {
          playsong();
        }
      }
      function playsong() {
        isPlaying = true;
        socket.emit("play", {});
        audio.play()
      }

      function pausesong() {
        console.log("Audio pause event detected");
        if (isPlaying) {
          isPlaying = false;
          socket.emit("pause", {});
          audio.pause();
        }
      }
      $(document).keyup(function(event) {
        if ($("#songurl").is(":focus") && event.key == "Enter") {
            var songurl = $("#songurl").val();
            console.log("Song URL:", songurl);
            $.ajax({
                type: "POST",
                url: "/add_song",
                data: JSON.stringify({ songurl: songurl }),
                contentType: "application/json",
                success: function (data) {
                    
                },
                error: function (error) {
                    console.error("Error adding song to queue:", error);
                },
            }
            )
        }
    });
      // Send timestamp every 500 milliseconds while audio is playing
      setInterval(function () {
        if (isPlaying) {
          console.log("Sending timestamp to server", {
            timestamp: audio.currentTime,
          });
          socket.emit("timestamp", { timestamp: audio.currentTime });
        }
      }, 500);

      setInterval(function () {
        console.log("Requesting sync from server");
        socket.emit("request_sync");
      }, syncInterval);

      // Log connection issues
      socket.on("connect_error", function (error) {
        console.error("Connection Error:", error);
      });

      socket.on("disconnect", function (reason) {
        console.log("Disconnected:", reason);
      });
    </script>
  </body>
</html>
